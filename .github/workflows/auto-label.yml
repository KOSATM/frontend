name: Auto Create & Apply Labels (Frontend)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Create missing labels then apply
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            // 브랜치 네이밍: menu/type/anything...
            const parts = pr.head.ref.split('/');
            const menu = parts[0];
            const type = parts[1];

            // 메뉴 라벨 색상 (프론트 공통)
            const menuLabels = {
              planner:    "4373FF",
              travelgram: "09B28B",
              mypage:     "8353E6",
              supporter:  "E69A53",
              common:     "444444"
            };

            // 작업 타입 라벨
            const typeLabels = {
              feat:     { name: "feat",     color: "2EB67D" },
              fix:      { name: "fix",      color: "D64545" },
              refactor: { name: "refactor", color: "A371F7" },
              style:    { name: "style",    color: "6F42C1" },
              design:   { name: "design",   color: "11AADD" }, // 프론트에서 자주 쓰는 design
              docs:     { name: "docs",     color: "0366D6" },
              test:     { name: "test",     color: "FF8800" },
              chore:    { name: "chore",    color: "999999" }
            };

            const needed = [];

            // 1) 메뉴 라벨이 정의되어 있으면 추가
            if (menuLabels[menu]) {
              needed.push({ name: menu, color: menuLabels[menu] });
            }

            // 2) 작업 타입 라벨 추가
            if (typeLabels[type]) {
              needed.push(typeLabels[type]);
            }

            // PR 이름과 브랜치가 맞지 않는 경우 early return
            if (needed.length === 0) return;

            // 레포의 존재하는 라벨 목록 조회
            const existing = await github.paginate(
              github.rest.issues.listLabelsForRepo,
              { owner: context.repo.owner, repo: context.repo.repo }
            );
            const existingNames = existing.map(l => l.name);

            // 3) 없는 라벨 자동 생성
            for (const lb of needed) {
              if (!existingNames.includes(lb.name)) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: lb.name,
                  color: lb.color
                });
              }
            }

            // 4) PR에 라벨 적용
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: needed.map(l => l.name)
            });
