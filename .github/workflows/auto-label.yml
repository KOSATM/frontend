name: Auto Create & Apply Labels (Frontend)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Create missing labels then apply
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            // 1. 브랜치 파싱 (대소문자 무시를 위해 소문자로 변환)
            // 예: Menu/Refactor/ABC -> menu / refactor
            const parts = pr.head.ref.split('/');
            if (parts.length < 2) return; // 포맷이 안맞으면 종료
            
            const menu = parts[0].toLowerCase(); 
            const type = parts[1].toLowerCase();

            // 메뉴 라벨 색상
            const menuLabels = {
              planner:    "4373FF",
              travelgram: "09B28B",
              mypage:     "8353E6",
              supporter:  "E69A53",
              common:     "444444"
            };

            // 작업 타입 라벨
            const typeLabels = {
              feat:     { name: "feat",     color: "2EB67D" },
              fix:      { name: "fix",      color: "D64545" },
              refactor: { name: "refactor", color: "A371F7" },
              style:    { name: "style",    color: "6F42C1" },
              design:   { name: "design",   color: "11AADD" },
              docs:     { name: "docs",     color: "0366D6" },
              test:     { name: "test",     color: "FF8800" },
              chore:    { name: "chore",    color: "999999" }
            };

            const needed = [];

            if (menuLabels[menu]) {
              needed.push({ name: menu, color: menuLabels[menu] });
            }

            if (typeLabels[type]) {
              needed.push(typeLabels[type]);
            }

            if (needed.length === 0) return;

            // 2. 라벨 생성 및 부착 로직 개선
            for (const lb of needed) {
              try {
                // 무조건 생성을 시도합니다.
                // 이미 존재하면 422 에러가 나지만 catch로 잡아서 무시합니다.
                // 이렇게 하면 매번 라벨 목록을 조회(paginate)할 필요가 없어 더 빠릅니다.
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: lb.name,
                  color: lb.color
                });
                console.log(`Created label: ${lb.name}`);
              } catch (error) {
                // 422: Validation Failed (이미 존재하는 경우 등)
                // 이미 존재하면 에러를 무시하고 넘어갑니다.
                if (error.status !== 422) {
                   console.log(`Failed to create label ${lb.name}: ${error.message}`);
                } else {
                   console.log(`Label ${lb.name} already exists. Skipping creation.`);
                }
              }
            }

            // 3. PR에 라벨 적용 (항상 실행됨)
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: needed.map(l => l.name)
            });